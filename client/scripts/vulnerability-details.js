// Vulnerability Details Page JavaScript

const API_BASE_URL = 'http://localhost:5231/api';

document.addEventListener('DOMContentLoaded', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const vulnerabilityId = urlParams.get('id');
    
    if (vulnerabilityId) {
        loadVulnerabilityDetails(vulnerabilityId);
    } else {
        document.getElementById('vulnerabilityDetails').innerHTML = 
            '<div class="alert alert-danger">No vulnerability ID provided</div>';
    }
});

async function loadVulnerabilityDetails(id) {
    try {
        const response = await fetch(`${API_BASE_URL}/vulnerabilities`);
        if (!response.ok) throw new Error('Failed to fetch vulnerabilities');
        
        const vulnerabilities = await response.json();
        const vulnerability = vulnerabilities.find(v => v.id === parseInt(id));
        
        if (vulnerability) {
            displayVulnerabilityDetails(vulnerability);
        } else {
            document.getElementById('vulnerabilityDetails').innerHTML = 
                '<div class="alert alert-danger">Vulnerability not found</div>';
        }
    } catch (error) {
        console.error('Error loading vulnerability:', error);
        document.getElementById('vulnerabilityDetails').innerHTML = 
            '<div class="alert alert-danger">Error loading vulnerability details</div>';
    }
}

function displayVulnerabilityDetails(vuln) {
    const container = document.getElementById('vulnerabilityDetails');
    const priorityScore = vuln.priorityScore || vuln.score;
    const scoreClass = getScoreClass(priorityScore);
    const soleSourceBadge = vuln.soleSourceFlag 
        ? '<span class="badge bg-danger ms-2"><i class="bi bi-exclamation-octagon"></i> Sole Source Dependency</span>' 
        : '';
    
    container.innerHTML = `
        <!-- Header -->
        <div class="card mb-4">
            <div class="card-header bg-dark text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3 class="mb-0">${vuln.cveId}${soleSourceBadge}</h3>
                        <p class="mb-0 mt-2">${vuln.title}</p>
                    </div>
                    <div class="text-end">
                        <span class="badge ${scoreClass} fs-6 px-3 py-2">Priority: ${priorityScore.toFixed(1)}</span>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Severity:</strong> <span class="badge ${getSeverityBadgeClass(vuln.severity)}">${vuln.severity}</span></p>
                        <p><strong>CVSS Score:</strong> ${vuln.score.toFixed(1)}</p>
                        <p><strong>Bio-Relevance Score:</strong> ${((vuln.bioRelevanceScore || 0) * 100).toFixed(0)}%</p>
                        <p><strong>Bio-Relevance Level:</strong> <span class="${getRelevanceClass(vuln.biotechRelevance)}">${vuln.biotechRelevance}</span></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Source:</strong> <span class="badge bg-secondary">${vuln.source}</span></p>
                        <p><strong>Source Credibility:</strong> ${vuln.sourceCredibility || 'Unknown'}</p>
                        <p><strong>Discovered:</strong> ${formatDate(vuln.discoveredDate)}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Description -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-file-text"></i> Description</h5>
            </div>
            <div class="card-body">
                <p>${vuln.description}</p>
            </div>
        </div>

        <!-- Biological Impact -->
        <div class="card mb-4">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="bi bi-flower1"></i> Biological Impact</h5>
            </div>
            <div class="card-body">
                <p>${vuln.biologicalImpact || 'Analysis pending'}</p>
            </div>
        </div>

        <!-- Human Impact -->
        <div class="card mb-4">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0"><i class="bi bi-person-exclamation"></i> Human Impact</h5>
            </div>
            <div class="card-body">
                <p>${vuln.humanImpact || 'Analysis pending'}</p>
            </div>
        </div>

        <!-- Affected Systems -->
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-cpu"></i> Affected Systems</h5>
            </div>
            <div class="card-body">
                ${vuln.affectedSystems.map(system => 
                    `<span class="badge bg-secondary me-2 mb-2">${system}</span>`
                ).join('')}
            </div>
        </div>

        <!-- Remediation Guidance -->
        ${vuln.remediationGuidance ? `
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-shield-check"></i> Remediation Guidance</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <h6>Steps:</h6>
                    <ol>
                        ${vuln.remediationGuidance.steps.map(step => `<li>${step}</li>`).join('')}
                    </ol>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <p><strong>Estimated Downtime:</strong> ${vuln.remediationGuidance.estimatedDowntime}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Requires Approval:</strong> ${vuln.remediationGuidance.requiresApproval ? '<span class="badge bg-warning">Yes</span>' : '<span class="badge bg-success">No</span>'}</p>
                    </div>
                </div>
                
                <div class="mb-3">
                    <h6>Rollback Procedure:</h6>
                    <p>${vuln.remediationGuidance.rollbackProcedure}</p>
                </div>
                
                ${vuln.remediationGuidance.safetyConstraints && vuln.remediationGuidance.safetyConstraints.length > 0 ? `
                <div class="alert alert-warning">
                    <h6><i class="bi bi-exclamation-triangle"></i> Safety Constraints:</h6>
                    <ul class="mb-0">
                        ${vuln.remediationGuidance.safetyConstraints.map(constraint => `<li>${constraint}</li>`).join('')}
                    </ul>
                </div>
                ` : ''}
                
                <button class="btn btn-primary" onclick="askChatbotAboutRemediation('${vuln.cveId}')">
                    <i class="bi bi-chat-dots"></i> Ask AI Assistant About Remediation
                </button>
            </div>
        </div>
        ` : ''}

        <!-- Actions -->
        <div class="card">
            <div class="card-body">
                <h5>Actions</h5>
                <button class="btn btn-primary me-2" onclick="createRemediationTicket(${vuln.id})">
                    <i class="bi bi-ticket"></i> Create Remediation Ticket
                </button>
                <button class="btn btn-outline-primary me-2" onclick="askChatbotAboutVuln('${vuln.cveId}')">
                    <i class="bi bi-chat-dots"></i> Ask AI Assistant
                </button>
                <button class="btn btn-outline-secondary" onclick="exportVulnerability(${vuln.id})">
                    <i class="bi bi-download"></i> Export Details
                </button>
            </div>
        </div>
    `;
}

function getScoreClass(score) {
    if (score >= 9.0) return 'bg-danger';
    if (score >= 7.0) return 'bg-warning';
    if (score >= 4.0) return 'bg-info';
    return 'bg-success';
}

function getSeverityBadgeClass(severity) {
    if (severity === 'Critical') return 'bg-danger';
    if (severity === 'High') return 'bg-warning';
    if (severity === 'Medium') return 'bg-info';
    return 'bg-success';
}

function getRelevanceClass(relevance) {
    if (relevance === 'Very High' || relevance === 'High') return 'text-danger fw-bold';
    if (relevance === 'Medium') return 'text-warning fw-bold';
    return 'text-success fw-bold';
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    });
}

function createRemediationTicket(vulnId) {
    window.location.href = `alerts.html?action=create-ticket&vulnId=${vulnId}`;
}

function askChatbotAboutVuln(cveId) {
    alert(`Opening AI Assistant to discuss ${cveId}. This would open the chatbot modal.`);
}

function askChatbotAboutRemediation(cveId) {
    alert(`Asking AI Assistant about remediation for ${cveId}. This would open the chatbot modal.`);
}

function exportVulnerability(vulnId) {
    alert(`Exporting vulnerability details for ID ${vulnId}. This would generate a PDF or CSV report.`);
}



